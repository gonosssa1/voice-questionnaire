<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Validated Insurance Questionnaire</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --brand-primary: #46199B;
      --brand-secondary: #7757C1;
      --brand-highlight: #C5B8DF;
      --brand-background: #F7F7F7;
      --brand-text: #111111;
      --brand-text-secondary: #737271;
      --brand-border: #A0A0A0;
    }
    body {
      font-family: "FSAlbertW05-Bold", "Open Sans", Helvetica, Arial, sans-serif;
    }
    @keyframes pulse-ring {
      0% { transform: scale(0.95); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.7; }
      100% { transform: scale(0.95); opacity: 1; }
    }
    .pulse-ring { animation: pulse-ring 1.5s ease-in-out infinite; }
    
    @keyframes sound-wave {
      0%, 100% { height: 8px; }
      50% { height: 24px; }
    }
    .sound-bar { animation: sound-wave 0.5s ease-in-out infinite; }
    .sound-bar:nth-child(2) { animation-delay: 0.1s; }
    .sound-bar:nth-child(3) { animation-delay: 0.2s; }
    .sound-bar:nth-child(4) { animation-delay: 0.3s; }
    .sound-bar:nth-child(5) { animation-delay: 0.4s; }
  </style>
</head>
<body class="min-h-screen bg-[var(--brand-background)] text-[var(--brand-text)] font-sans">

  <div id="app"></div>

  <script>
    // ============================================================================
    // SERVER CONFIGURATION (loaded from backend)
    // ============================================================================
    
    let serverConfig = {
      ttsEnabled: false,
      validationEnabled: false,
      validationProvider: 'anthropic',
    };

    // Load config from server
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        serverConfig = await response.json();
        console.log('Server config loaded:', serverConfig);
      } catch (error) {
        console.error('Failed to load server config:', error);
      }
    }

    // ============================================================================
    // QUESTION SCRIPT - Exactly what will be asked, in exact order
    // ============================================================================

    const QUESTIONS = [
      // === Customer Identification ===
      {
        id: 'cust_id_first_name',
        section: 'Welcome',
        question: 'Can I have your first name?',
        type: 'open',
      },
      {
        id: 'cust_id_last_name',
        section: 'Welcome',
        question: 'Can I have your last name?',
        type: 'open',
      },

      {
        id: 'cust_id_gender',
        section: 'Welcome',
        question: 'Can I have your your physical gender?',
        type: 'open',
      },

      // === PRIMARY MEDICAL PROVIDER ===
      {
        id: 'pmv.has_primary_provider',
        section: 'Primary Medical Provider',
        question: 'Do you have a primary medical provider?',
        type: 'yes_no',
        onNo: 'pmv.other_provider_reason',
      },
      {
        id: 'pmv.last_visit_reason',
        section: 'Primary Medical Provider',
        question: 'What was the reason for your last visit or consultation with your primary medical provider?',
        type: 'open',
        requires: { id: 'pmv.has_primary_provider', answer: 'YES' },
      },
      {
        id: 'pmv.last_visit_date',
        section: 'Primary Medical Provider',
        question: 'When was this visit?',
        type: 'date',
        requires: { id: 'pmv.has_primary_provider', answer: 'YES' },
      },
      {
        id: 'pmv.last_visit_results',
        section: 'Primary Medical Provider',
        question: 'What were the results?',
        type: 'open',
        requires: { id: 'pmv.has_primary_provider', answer: 'YES' },
      },
      {
        id: 'pmv.last_visit_treatment',
        section: 'Primary Medical Provider',
        question: 'What treatment or medications were prescribed?',
        type: 'open',
        requires: { id: 'pmv.has_primary_provider', answer: 'YES' },
      },
      {
        id: 'pmv.last_visit_provider_name',
        section: 'Primary Medical Provider',
        question: 'Do you know the name of the medical provider you saw for this checkup?',
        type: 'open',
        requires: { id: 'pmv.has_primary_provider', answer: 'YES' },
      },
      {
        id: 'pmv.other_provider_reason',
        section: 'Primary Medical Provider',
        question: 'Other than your primary medical provider, what was the reason for your last visit or consultation with any medical provider?',
        type: 'open',
        requires: { id: 'pmv.has_primary_provider', answer: 'NO' },
      },
      
      
      
      // === NEUROLOGICAL ===
      {
        id: 'neuro.gateway',
        section: 'Neurological',
        question: 'Have you ever been diagnosed with any disorder or disease of the brain, spinal cord or nervous system?',
        type: 'yes_no',
        onNo: 'psych.gateway',
      },
      {
        id: 'neuro.dx_list',
        section: 'Neurological',
        question: 'What specific neurological condition(s) were diagnosed?',
        type: 'open',
        requires: { id: 'neuro.gateway', answer: 'YES' },
      },
      {
        id: 'neuro.dx_dates',
        section: 'Neurological',
        question: 'Date of first diagnosis and date of most recent symptoms?',
        type: 'open',
        requires: { id: 'neuro.gateway', answer: 'YES' },
      },
      {
        id: 'neuro.hosp_impairment',
        section: 'Neurological',
        question: 'Any hospitalizations, ER visits, seizures/episodes, or functional limitations in the past 5 years?',
        type: 'open',
        requires: { id: 'neuro.gateway', answer: 'YES' },
      },
      
      // === PSYCHIATRIC ===
      {
        id: 'psych.gateway',
        section: 'Psychiatric',
        question: 'Have you ever been diagnosed with any psychiatric, nervous, emotional, or mental disorder or disease?',
        type: 'yes_no',
        onNo: 'eent.gateway',
      },
      {
        id: 'psych.dx_list',
        section: 'Psychiatric',
        question: 'What diagnosis(es) apply? (e.g., ADHD/ADD, anxiety, depression, bipolar, PTSD, etc.)',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.dx_dates',
        section: 'Psychiatric',
        question: 'When was this condition diagnosed?',
        type: 'date',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.current_tx',
        section: 'Psychiatric',
        question: 'Are you currently under treatment or taking medication for the condition?',
        type: 'yes_no',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.meds_count',
        section: 'Psychiatric',
        question: 'How many medications do you take, if any?',
        type: 'number',
        requires: { id: 'psych.current_tx', answer: 'YES' },
      },
      {
        id: 'psych.meds_names',
        section: 'Psychiatric',
        question: 'What is/are the name(s) of the medication(s)?',
        type: 'open',
        requires: { id: 'psych.current_tx', answer: 'YES' },
      },
      {
        id: 'psych.disability_hosp',
        section: 'Psychiatric',
        question: 'In the past 3 years: any disability payments, missed >1 week of work, ER/hospitalization, or self-harm/suicidal ideation?',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.provider_name',
        section: 'Psychiatric',
        question: 'Do you know the name of the medical provider you saw for this condition?',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.med_changes_12m',
        section: 'Psychiatric',
        question: 'Any medication changes, dose increases, or new prescriptions in the past 12 months?',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.comorbid',
        section: 'Psychiatric',
        question: 'Any comorbid mental health diagnoses or active symptoms (panic attacks, major depression episodes, mania, etc.)?',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      {
        id: 'psych.substance_misuse',
        section: 'Psychiatric',
        question: 'Have you ever been diagnosed with any history of substance abuse, dependence, or misuse of prescribed medications?',
        type: 'open',
        requires: { id: 'psych.gateway', answer: 'YES' },
      },
      
      // === EENT ===
      {
        id: 'eent.gateway',
        section: 'EENT',
        question: 'Any disorder or disease of the eyes, ears, nose, or throat?',
        type: 'yes_no',
        onNo: 'cardio.gateway',
      },
      {
        id: 'eent.dx',
        section: 'EENT',
        question: 'What condition (e.g., hearing loss, glaucoma, chronic sinusitis)?',
        type: 'open',
        requires: { id: 'eent.gateway', answer: 'YES' },
      },
      {
        id: 'eent.treatment',
        section: 'EENT',
        question: 'Is the condition corrected/treated (surgery, hearing aids, lenses, medication)?',
        type: 'open',
        requires: { id: 'eent.gateway', answer: 'YES' },
      },
      {
        id: 'eent.impairment',
        section: 'EENT',
        question: 'Does it impair daily activities, driving, or job duties?',
        type: 'open',
        requires: { id: 'eent.gateway', answer: 'YES' },
      },
      
      // === CARDIOVASCULAR ===
      {
        id: 'cardio.gateway',
        section: 'Cardiovascular',
        question: 'Have you ever been diagnosed with any disorder or disease of the heart, blood vessels, or circulatory system (including high blood pressure/high cholesterol)?',
        type: 'yes_no',
        onNo: 'resp.gateway',
      },
      {
        id: 'cardio.dx',
        section: 'Cardiovascular',
        question: 'What diagnosis(es) apply? (e.g., hypertension, hyperlipidemia, CAD, arrhythmia)',
        type: 'open',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.dx_date',
        section: 'Cardiovascular',
        question: 'When was the condition diagnosed?',
        type: 'date',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.bp_known',
        section: 'Cardiovascular',
        question: 'Do you know your most recent blood pressure reading?',
        type: 'yes_no',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.on_meds',
        section: 'Cardiovascular',
        question: 'Are you taking medication for this condition?',
        type: 'yes_no',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.bp_sys',
        section: 'Cardiovascular',
        question: 'Most recent systolic blood pressure (top number)?',
        type: 'number',
        requires: { id: 'cardio.bp_known', answer: 'YES' },
      },
      {
        id: 'cardio.bp_dia',
        section: 'Cardiovascular',
        question: 'Most recent diastolic blood pressure (bottom number)?',
        type: 'number',
        requires: { id: 'cardio.bp_known', answer: 'YES' },
      },
      {
        id: 'cardio.provider_name',
        section: 'Cardiovascular',
        question: 'Do you know the name of the medical provider you saw for this condition?',
        type: 'open',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.control_duration',
        section: 'Cardiovascular',
        question: 'How long have readings been controlled at roughly the current level?',
        type: 'open',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.comorbid',
        section: 'Cardiovascular',
        question: 'Any related conditions (diabetes, kidney disease, stroke/TIA, heart disease)?',
        type: 'open',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      {
        id: 'cardio.testing_hosp',
        section: 'Cardiovascular',
        question: 'Any chest pain, shortness of breath on exertion, abnormal EKG/echo/stress test, ER visit, or hospitalization?',
        type: 'open',
        requires: { id: 'cardio.gateway', answer: 'YES' },
      },
      
      // === RESPIRATORY ===
      {
        id: 'resp.gateway',
        section: 'Respiratory',
        question: 'Have you ever been diagnosed with any disorder or disease of the respiratory system (asthma, COPD, sleep apnea, etc.)?',
        type: 'yes_no',
        onNo: 'END',
      },
      {
        id: 'resp.dx',
        section: 'Respiratory',
        question: 'What condition (asthma, sleep apnea, COPD, chronic bronchitis, etc.)?',
        type: 'open',
        requires: { id: 'resp.gateway', answer: 'YES' },
      },
      {
        id: 'resp.severity',
        section: 'Respiratory',
        question: 'How would you rate severity (mild/moderate/severe) and current control?',
        type: 'open',
        requires: { id: 'resp.gateway', answer: 'YES' },
      },
      {
        id: 'resp.exacerbations',
        section: 'Respiratory',
        question: 'Any hospitalizations/ER visits, steroid bursts, CPAP/oxygen therapy use in past 5 years?',
        type: 'open',
        requires: { id: 'resp.gateway', answer: 'YES' },
      },
    ];
   
/*      const INTRO_MESSAGE = 
      "Hello, and thank you for starting your insurance application. " +
      "I will now ask you a series of medical history questions. " +
      "Please answer each question clearly. " +
      "For yes or no questions, please respond with yes or no. " +
      "Let's begin."; */

      const INTRO_MESSAGE =
      "Hello and Thank you for choosing Protective Life. During this phone call I will ask several questions regarding your health, medications, some financials, even past or future travel. What this information will do is help us understand your health and financial situation as it relates to life insurance.";
      
    const COMPLETION_MESSAGE = 
      "Thank you choosing Protective Life. " +
      "Your responses have been recorded. " +
      "A representative will review your information and contact you within 24 to 48 hours.";

    const MAX_RETRIES = 3;

    // ============================================================================
    // TEXT-TO-SPEECH SERVICE
    // ============================================================================
    
    class TTSService {
      constructor() {
        this.audioContext = null;
        this.currentSource = null;
        this.isSpeaking = false;
      }

      async speak(text) {
        this.isSpeaking = true;
        
        try {
          if (serverConfig.ttsEnabled) {
            await this.speakElevenLabs(text);
          } else {
            await this.speakWebSpeech(text);
          }
        } finally {
          this.isSpeaking = false;
        }
      }

      async speakElevenLabs(text) {
        try {
          const response = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
          });

          if (!response.ok) {
            console.error('TTS API error, falling back to Web Speech');
            return this.speakWebSpeech(text);
          }

          const arrayBuffer = await response.arrayBuffer();
          
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }

          const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
          
          return new Promise((resolve) => {
            const source = this.audioContext.createBufferSource();
            this.currentSource = source;
            source.buffer = audioBuffer;
            source.connect(this.audioContext.destination);
            source.onended = () => {
              this.currentSource = null;
              resolve();
            };
            source.start(0);
          });
        } catch (error) {
          console.error('ElevenLabs error:', error);
          return this.speakWebSpeech(text);
        }
      }

      speakWebSpeech(text) {
        return new Promise((resolve) => {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          utterance.pitch = 1;
          utterance.onend = resolve;
          utterance.onerror = () => resolve();
          window.speechSynthesis.speak(utterance);
        });
      }

      stop() {
        this.isSpeaking = false;
        if (this.currentSource) {
          try { this.currentSource.stop(); } catch (e) {}
          this.currentSource = null;
        }
        window.speechSynthesis.cancel();
      }
    }

    // ============================================================================
    // SPEECH RECOGNITION SERVICE
    // ============================================================================
    
    class ASRService {
      constructor() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = SpeechRecognition ? new SpeechRecognition() : null;
        
        if (this.recognition) {
          this.recognition.continuous = false;
          this.recognition.interimResults = false;
          this.recognition.lang = 'en-US';
          this.recognition.maxAlternatives = 1;
        }
      }

      isSupported() {
        return !!this.recognition;
      }

      listen(timeoutMs = 10000) {
        return new Promise((resolve, reject) => {
          if (!this.recognition) {
            reject(new Error('Speech recognition not supported'));
            return;
          }

          let resolved = false;
          let timeoutId = null;

          const cleanup = () => {
            if (timeoutId) clearTimeout(timeoutId);
          };

          this.recognition.onresult = (event) => {
            if (!resolved) {
              resolved = true;
              cleanup();
              resolve(event.results[0][0].transcript);
            }
          };

          this.recognition.onerror = (event) => {
            if (!resolved && event.error !== 'no-speech') {
              resolved = true;
              cleanup();
              reject(new Error(event.error));
            }
          };

          this.recognition.onend = () => {
            if (!resolved) {
              resolved = true;
              cleanup();
              resolve('');
            }
          };

          timeoutId = setTimeout(() => {
            if (!resolved) {
              resolved = true;
              this.recognition.stop();
              cleanup();
              resolve('');
            }
          }, timeoutMs);

          this.recognition.start();
        });
      }

      stop() {
        if (this.recognition) {
          try { this.recognition.stop(); } catch (e) {}
        }
      }
    }

    // ============================================================================
    // VALIDATION SERVICE (calls backend API)
    // ============================================================================
    
    class ValidationService {
      async validate(question, questionType, transcript, choices = null) {
        try {
          const response = await fetch('/api/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, questionType, transcript, choices }),
          });

          if (!response.ok) {
            throw new Error('Validation API error');
          }

          return await response.json();
        } catch (error) {
          console.error('Validation error:', error);
          return { valid: false, normalized: null, explanation: null, repeat: false };
        }
      }
    }

    // ============================================================================
    // FLOW CONTROLLER
    // ============================================================================
    
    class FlowController {
      constructor() {
        this.tts = new TTSService();
        this.asr = new ASRService();
        this.validator = new ValidationService();
        this.sessionId = 0;
        
        this.state = {
          status: 'idle',
          currentQuestionIndex: -1,
          answers: {},
          transcript: [],
          retryCount: 0,
          error: null,
        };
        
        this.onStateChange = null;
      }

      setState(updates) {
        this.state = { ...this.state, ...updates };
        if (this.onStateChange) this.onStateChange(this.state);
      }

      findNextQuestionIndex(fromIndex, answers) {
        for (let i = fromIndex; i < QUESTIONS.length; i++) {
          const q = QUESTIONS[i];
          
          if (q.requires) {
            const dependentAnswer = answers[q.requires.id];
            if (dependentAnswer !== q.requires.answer) {
              continue;
            }
          }
          
          return i;
        }
        return -1;
      }

      handleSkipTo(skipToId, currentIndex, answers) {
        if (skipToId === 'END') return -1;
        
        const targetIndex = QUESTIONS.findIndex(q => q.id === skipToId);
        if (targetIndex !== -1) {
          return this.findNextQuestionIndex(targetIndex, answers);
        }
        return this.findNextQuestionIndex(currentIndex + 1, answers);
      }

      async askQuestion(questionIndex, options = {}) {
        const { preserveRetryCount = false } = options;
        const sessionId = this.sessionId;
        if (questionIndex < 0 || questionIndex >= QUESTIONS.length) {
          this.setState({ status: 'speaking', currentQuestionIndex: -1 });
          this.state.transcript.push({ role: 'assistant', text: COMPLETION_MESSAGE });
          await this.tts.speak(COMPLETION_MESSAGE);
          if (this.sessionId !== sessionId) return;
          this.setState({ status: 'complete' });
          return;
        }

        const question = QUESTIONS[questionIndex];
        this.setState({ 
          status: 'speaking', 
          currentQuestionIndex: questionIndex,
          retryCount: preserveRetryCount ? this.state.retryCount : 0 
        });

      // Announce the Lifestyle and Medical Related questions

        const Lifestyle_and_Medical_Message = "Next we will be going through some Lifestyle and medical related questions. Please keep in mind that the answers are assumed to be to the best of your knowledge. In order to expedite the overall application process we do like to obtain as much information as possible up front to eliminate any delays."
        if (questionIndex ===4) {
          this.state.transcript.push({ role: 'assistant', text: Lifestyle_and_Medical_Message });
          await this.tts.speak(Lifestyle_and_Medical_Message);
        } 

      // Announce the Medical Conditions related questions

        const Medical_Conditions_Message = "Now we will go through some specific medical conditions. I will read a few of them for you at a time. Please let me know if you have had any of the conditions so that we can obtain additional information where necessary."
        if (questionIndex ===10) {
          this.state.transcript.push({ role: 'assistant', text: Medical_Conditions_Message });
          await this.tts.speak(Medical_Conditions_Message);
        } 

        this.state.transcript.push({ role: 'assistant', text: question.question });
        await this.tts.speak(question.question);
        if (this.sessionId !== sessionId) return;

        this.setState({ status: 'listening' });
        
        try {
          const spokenAnswer = await this.asr.listen(15000);
          if (this.sessionId !== sessionId) return;
          
          if (!spokenAnswer) {
            if (this.state.retryCount < MAX_RETRIES) {
              this.setState({ retryCount: this.state.retryCount + 1 });
              await this.tts.speak("I didn't hear anything. Let me repeat the question.");
              if (this.sessionId !== sessionId) return;
              return this.askQuestion(questionIndex);
            } else {
              await this.tts.speak("I'm having trouble hearing you. Let's move on.");
              if (this.sessionId !== sessionId) return;
              this.state.answers[question.id] = 'NO_RESPONSE';
              return this.advanceToNextQuestion(questionIndex, 'NO_RESPONSE');
            }
          }

          this.state.transcript.push({ role: 'user', text: spokenAnswer });
          
          if (this.isRepeatRequest(spokenAnswer)) {
            const acknowledgement = "Sure, I'll repeat the question.";
            this.state.transcript.push({ role: 'assistant', text: acknowledgement });
            this.setState({ status: 'speaking' });
            await this.tts.speak(acknowledgement);
            if (this.sessionId !== sessionId) return;
            return this.askQuestion(questionIndex, { preserveRetryCount: true });
          }

          this.setState({ status: 'validating' });
          const validation = await this.validator.validate(
            question.question,
            question.type,
            spokenAnswer,
            question.choices
          );
          if (this.sessionId !== sessionId) return;

          if (validation.repeat) {
            const acknowledgement = "Sure, I'll repeat the question.";
            this.state.transcript.push({ role: 'assistant', text: acknowledgement });
            this.setState({ status: 'speaking' });
            await this.tts.speak(acknowledgement);
            if (this.sessionId !== sessionId) return;
            return this.askQuestion(questionIndex, { preserveRetryCount: true });
          }

          if (!validation.valid) {
            if (this.state.retryCount < MAX_RETRIES) {
              const retryNum = this.state.retryCount + 1;
              this.setState({ retryCount: retryNum });

              const explanation = validation.explanation || this.getGenericExplanation(question.type);
              const escalation = retryNum === 2 ? " Let's try once more." : "";
              const clarification = explanation + escalation;

              this.state.transcript.push({ role: 'assistant', text: clarification });
              await this.tts.speak(clarification);
              if (this.sessionId !== sessionId) return;
              return this.askQuestion(questionIndex);
            } else {
              await this.tts.speak("Let's move on to the next question.");
              if (this.sessionId !== sessionId) return;
              this.state.answers[question.id] = spokenAnswer;
              return this.advanceToNextQuestion(questionIndex, spokenAnswer);
            }
          }

          const normalizedAnswer = validation.normalized;
          this.state.answers[question.id] = normalizedAnswer;
          
          await this.tts.speak("Thank you.");
          if (this.sessionId !== sessionId) return;
          
          this.advanceToNextQuestion(questionIndex, normalizedAnswer);

        } catch (error) {
          console.error('ASR Error:', error);
          this.setState({ error: error.message, status: 'idle' });
        }
      }

      isRepeatRequest(transcript) {
        const normalized = transcript.toLowerCase().trim();
        const patterns = [
          'repeat',
          'say that again',
          'say it again',
          'can you repeat',
          'could you repeat',
          'please repeat',
          'repeat that',
          'what was that',
          'pardon',
          'come again',
          'say again',
          'repeat please',
          'huh',
          'sorry',
          'what did you say',
          'what was the question',
          'what'
        ];
        return patterns.some((p) => normalized.includes(p));
      }

      getGenericExplanation(questionType) {
        switch (questionType) {
          case 'yes_no':
            return 'Please answer with a clear yes or no.';
          case 'date':
            return 'Please provide a date.';
          case 'number':
            return 'Please provide a number.';
          case 'choice':
            return 'Please choose one of the options.';
          case 'open':
          default:
            return 'Please provide a valid response.';
        }
      }

      advanceToNextQuestion(currentIndex, answer) {
        const question = QUESTIONS[currentIndex];
        let nextIndex;

        if (question.onNo && answer === 'NO') {
          nextIndex = this.handleSkipTo(question.onNo, currentIndex, this.state.answers);
        } else {
          nextIndex = this.findNextQuestionIndex(currentIndex + 1, this.state.answers);
        }

        this.askQuestion(nextIndex);
      }

      async start() {
        this.sessionId += 1;
        const sessionId = this.sessionId;
        this.setState({
          status: 'speaking',
          currentQuestionIndex: -1,
          answers: {},
          transcript: [],
          retryCount: 0,
          error: null,
        });

        this.state.transcript.push({ role: 'assistant', text: INTRO_MESSAGE });
        await this.tts.speak(INTRO_MESSAGE);
        if (this.sessionId !== sessionId) return;

        const firstIndex = this.findNextQuestionIndex(0, {});
        this.askQuestion(firstIndex);
      }

      stop() {
        this.sessionId += 1;
        this.tts.stop();
        this.asr.stop();
        this.setState({ status: 'idle' });
      }
    }

    // ============================================================================
    // UI RENDERER
    // ============================================================================
    
    const controller = new FlowController();

    function render(state) {
      const app = document.getElementById('app');
      const question = state.currentQuestionIndex >= 0 && state.currentQuestionIndex < QUESTIONS.length
        ? QUESTIONS[state.currentQuestionIndex]
        : null;
      
      const progress = state.currentQuestionIndex >= 0
        ? Math.min(100, Math.round(((state.currentQuestionIndex + 1) / QUESTIONS.length) * 100))
        : 0;

      app.innerHTML = `
        <!-- Header -->
        <header class="sticky top-0 z-10">
          <div class="bg-white border-b border-[var(--brand-border)] px-6 py-2">
            <div class="max-w-6xl mx-auto flex items-center justify-between text-[var(--brand-primary)] text-sm font-semibold">
              <span>Protective Life</span>
              <span>AI Voice Application Prototype</span>
            </div>
          </div>
          <div class="bg-[var(--brand-primary)] px-6 py-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between text-white">
              <div class="flex items-center gap-4">
                <img src="logo.svg" alt="Protective Life logo" class="h-8 w-auto" />
                <div>
                  <h1 class="text-xl font-bold">Medical History Questionnaire</h1>
                  <p class="text-sm text-white/80">Insurance Application</p>
                </div>
              </div>
              ${state.status !== 'idle' && state.status !== 'complete' && question ? `
                <div class="text-right">
                  <div class="text-sm font-semibold">${question.section}</div>
                  <div class="text-xs text-white/70">Question ${state.currentQuestionIndex + 1} of ${QUESTIONS.length}</div>
                </div>
              ` : ''}
            </div>
          </div>
        </header>

        <!-- Progress -->
        ${state.status !== 'idle' ? `
          <div class="bg-white px-6 py-2 border-b border-[var(--brand-border)]">
            <div class="max-w-6xl mx-auto">
              <div class="flex justify-between text-xs text-[var(--brand-text-secondary)] mb-1">
                <span>Progress</span>
                <span>${progress}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-[var(--brand-primary)] h-1.5 rounded-full transition-all duration-500"
                     style="width: ${progress}%"></div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Main -->
        <main class="max-w-6xl mx-auto px-6 py-12">
          <div class="flex gap-8">
            <div class="flex-1">
              ${state.status === 'idle' ? renderIdle(state) : ''}
              ${['speaking', 'listening', 'validating'].includes(state.status) ? renderActive(state, question) : ''}
              ${state.status === 'complete' ? renderComplete(state) : ''}
            </div>
            ${['idle', 'complete'].includes(state.status) ? '' : renderChatFeed(state)}
          </div>
        </main>
      `;

      // Event handlers
      document.getElementById('startBtn')?.addEventListener('click', () => controller.start());
      document.getElementById('endBtn')?.addEventListener('click', () => controller.stop());
      document.getElementById('restartBtn')?.addEventListener('click', () => {
        controller.state = { ...controller.state, status: 'idle' };
        render(controller.state);
      });

      const chatScroll = document.getElementById('chatScroll');
      if (chatScroll) {
        chatScroll.scrollTop = chatScroll.scrollHeight;
      }
    }

    function renderIdle(state) {
      const isSupported = new ASRService().isSupported();

      return `
        <div class="text-center">
          <div class="mb-8">
            <div class="w-40 h-40 mx-auto bg-[var(--brand-primary)] rounded-full flex items-center justify-center mb-8 shadow-xl">
              <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </div>
            <h2 class="text-3xl font-bold mb-4">Ready to Begin</h2>
            <p class="text-[var(--brand-text-secondary)] mb-8 max-w-lg mx-auto leading-relaxed">
              This questionnaire will ask about your medical history using voice interaction. 
              Please ensure you're in a quiet environment and speak clearly.
            </p>
          </div>

          <button id="startBtn" 
                  class="px-10 py-4 bg-[var(--brand-primary)] hover:bg-[var(--brand-secondary)] 
                         rounded-full text-lg font-semibold text-white transition-all shadow-xl 
                         hover:scale-105">
            Start Application
          </button>

          ${!isSupported ? `
            <div class="mt-6 p-4 bg-white border border-[var(--brand-border)] rounded-xl max-w-md mx-auto shadow-xl">
              <p class="text-[var(--brand-text-secondary)] text-sm">
                ‚ö†Ô∏è Voice recognition is not supported in this browser. Please use Chrome or Edge.
              </p>
            </div>
          ` : ''}

          ${state.error ? `
            <div class="mt-6 p-4 bg-white border border-red-300 rounded-xl max-w-md mx-auto shadow-xl">
              <p class="text-red-600 text-sm">${state.error}</p>
            </div>
          ` : ''}

        </div>
      `;
    }

    function renderActive(state, question) {
      const configs = {
        speaking: {
          color: 'bg-[var(--brand-primary)]',
          shadow: 'shadow-xl',
          label: 'Speaking',
          sublabel: 'Please listen to the question',
        },
        listening: {
          color: 'bg-[var(--brand-secondary)]',
          shadow: 'shadow-xl',
          label: 'Listening',
          sublabel: 'Please speak your answer clearly',
        },
        validating: {
          color: 'bg-[var(--brand-highlight)]',
          shadow: 'shadow-xl',
          label: 'Processing',
          sublabel: 'Analyzing your response with AI',
        },
      };
      
      const cfg = configs[state.status];

      return `
        <div class="text-center">
          <!-- Status Indicator -->
          <div class="mb-10">
            <div class="w-40 h-40 mx-auto ${cfg.color} rounded-full flex items-center justify-center mb-8 
                        ${cfg.shadow} ${state.status !== 'validating' ? 'pulse-ring' : ''}">
              ${state.status === 'speaking' ? `
                <div class="flex items-center gap-1">
                  ${[1,2,3,4,5].map(() => `<div class="w-1.5 bg-white rounded-full sound-bar"></div>`).join('')}
                </div>
              ` : state.status === 'listening' ? `
                <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
              ` : `
                <svg class="w-16 h-16 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              `}
            </div>
            <h2 class="text-2xl font-bold mb-2">${cfg.label}</h2>
            <p class="text-[var(--brand-text-secondary)]">${cfg.sublabel}</p>
          </div>

          <!-- Current Question -->
          ${question ? `
            <div class="bg-white rounded-xl p-8 mb-10 max-w-2xl mx-auto border-t-4 border-[var(--brand-primary)] shadow-xl">
              <p class="text-xl leading-relaxed">${question.question}</p>
              ${question.type === 'yes_no' ? `
                <p class="text-sm text-[var(--brand-text-secondary)] mt-4">Please answer yes or no</p>
              ` : ''}
              ${question.type === 'choice' && question.choices ? `
                <p class="text-sm text-[var(--brand-text-secondary)] mt-4">Options: ${question.choices.join(', ')}</p>
              ` : ''}
            </div>
          ` : ''}

          <!-- Retry indicator -->
          ${state.retryCount > 0 ? `
            <p class="text-[var(--brand-text-secondary)] text-sm mb-6">Attempt ${state.retryCount + 1} of ${MAX_RETRIES + 1}</p>
          ` : ''}

          <!-- End Call Button -->
          <button id="endBtn" 
                  class="px-8 py-3 bg-white text-red-600 border border-red-300 hover:border-red-400 rounded-full font-semibold transition-colors shadow-sm">
            End Call
          </button>
        </div>
      `;
    }

    function renderComplete(state) {
      const summaryItems = Object.entries(state.answers).map(([id, answer]) => {
        const q = QUESTIONS.find(q => q.id === id);
        return `
          <div class="flex justify-between py-3 border-b border-gray-200 last:border-0">
            <span class="text-[var(--brand-text-secondary)] text-sm flex-1 pr-4">${q?.question || id}</span>
            <span class="font-medium text-sm text-right max-w-[200px]">${answer}</span>
          </div>
        `;
      }).join('');

      return `
        <div class="text-center">
          <div class="w-32 h-32 mx-auto bg-[var(--brand-primary)] rounded-full 
                      flex items-center justify-center mb-8 shadow-xl">
            <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-3xl font-bold mb-4">Application Complete</h2>
          <p class="text-[var(--brand-text-secondary)] mb-10 max-w-lg mx-auto">
            Thank you for completing the questionnaire. Your responses have been recorded.
          </p>

          <!-- Summary -->
          <div class="bg-white rounded-xl p-6 max-w-2xl mx-auto text-left border-t-4 border-[var(--brand-primary)] shadow-xl">
            <h3 class="font-semibold mb-4 text-lg">Response Summary</h3>
            <div class="max-h-96 overflow-y-auto">
              ${summaryItems || '<p class="text-[var(--brand-text-secondary)]">No responses recorded</p>'}
            </div>
          </div>

          <button id="restartBtn" 
                  class="mt-10 px-8 py-3 bg-[var(--brand-primary)] hover:bg-[var(--brand-secondary)] 
                         text-white rounded-full font-semibold transition-all shadow-xl">
            Start New Application
          </button>
        </div>
      `;
    }

    function renderTranscript(state) {
      const transcriptHtml = state.transcript.map(entry => `
        <div class="py-2 ${entry.role === 'user' ? 'text-blue-400' : 'text-slate-300'}">
          <span class="font-semibold text-xs uppercase tracking-wide opacity-60">
            ${entry.role === 'user' ? 'User' : 'System'}:
          </span>
          <span class="ml-2">${entry.text}</span>
        </div>
      `).join('');

      return `
        <div class="fixed bottom-4 right-4 z-50">
          <details class="bg-slate-900/95 backdrop-blur rounded-lg border border-slate-700 shadow-xl max-w-md">
            <summary class="px-4 py-2 cursor-pointer text-slate-400 hover:text-white text-sm">
              üìù Transcript (${state.transcript.length})
            </summary>
            <div class="px-4 pb-4 max-h-64 overflow-y-auto text-sm">
              ${transcriptHtml}
            </div>
          </details>
        </div>
      `;
    }

    function renderChatFeed(state) {
      const bubbleHtml = state.transcript.map(entry => {
        const isUser = entry.role === 'user';
        const bubbleClass = isUser
          ? 'bg-[var(--brand-primary)] text-white rounded-2xl rounded-br-sm'
          : 'bg-gray-200 text-[var(--brand-text)] rounded-2xl rounded-bl-sm';
        const alignClass = isUser ? 'justify-end' : 'justify-start';

        return `
          <div class="flex ${alignClass}">
            <div class="max-w-[220px] px-4 py-2 text-sm leading-relaxed ${bubbleClass}">
              ${entry.text}
            </div>
          </div>
        `;
      }).join('');

      const showUserTyping = state.status === 'listening' && state.transcript.length > 0;
      const showSystemTyping = ['speaking', 'validating'].includes(state.status) && state.transcript.length > 0;

      const typingDots = (alignRight) => `
        <div class="flex ${alignRight ? 'justify-end' : 'justify-start'}">
          <div class="flex items-center gap-1 px-4 py-2 rounded-2xl ${alignRight ? 'bg-[var(--brand-primary)]' : 'bg-gray-200'}">
            <span class="w-1.5 h-1.5 rounded-full ${alignRight ? 'bg-white/80' : 'bg-[var(--brand-text-secondary)]'} animate-bounce [animation-delay:-0.2s]"></span>
            <span class="w-1.5 h-1.5 rounded-full ${alignRight ? 'bg-white/80' : 'bg-[var(--brand-text-secondary)]'} animate-bounce [animation-delay:-0.1s]"></span>
            <span class="w-1.5 h-1.5 rounded-full ${alignRight ? 'bg-white/80' : 'bg-[var(--brand-text-secondary)]'} animate-bounce"></span>
          </div>
        </div>
      `;

      return `
        <aside class="w-80 shrink-0">
          <div class="bg-white border-t-4 border-[var(--brand-primary)] rounded-3xl p-4 shadow-xl h-[520px] flex flex-col">
            <div class="flex items-center gap-3 pb-4 border-b border-gray-200">
              <div class="w-10 h-10 rounded-full bg-[var(--brand-primary)] flex items-center justify-center">
                <span class="text-sm font-semibold text-white">AI</span>
              </div>
              <div>
                <div class="text-sm font-semibold">Underwriting Assistant</div>
                <div class="text-xs text-[var(--brand-text-secondary)]">Live demo transcript</div>
              </div>
            </div>
            <div id="chatScroll" class="flex-1 overflow-y-auto space-y-3 py-4 pr-1">
              ${bubbleHtml || '<div class="text-[var(--brand-text-secondary)] text-sm">Conversation will appear here.</div>'}
              ${showUserTyping ? typingDots(true) : ''}
              ${showSystemTyping ? typingDots(false) : ''}
            </div>
            <div class="pt-3 border-t border-gray-200">
              <div class="bg-[var(--brand-background)] rounded-xl px-4 py-3 text-[var(--brand-text-secondary)] text-xs">
                Voice mode enabled
              </div>
            </div>
          </div>
        </aside>
      `;
    }

    // Initialize
    async function init() {
      await loadConfig();
      controller.onStateChange = render;
      render(controller.state);
    }

    init();
  </script>
</body>
</html>
